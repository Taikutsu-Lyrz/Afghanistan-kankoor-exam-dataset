name: Update Total Questions

on:
  push:
    branches: [main, master]
    paths:
      - 'dataset/data/**/*.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-count:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Count questions and generate table
        run: |
          echo "| Subject | Questions |" > table.tmp
          echo "|---------|----------|" >> table.tmp
          
          total=0
          
          for file in dataset/data/*/*.json; do
            if [ -f "$file" ] && [ "$(basename "$file")" != "schema.json" ]; then
              folder=$(basename "$(dirname "$file")")
              count=$(jq 'length' "$file" 2>/dev/null || echo 0)
              
              # Format subject name (capitalize, replace underscores)
              subject=$(echo "$folder" | sed 's/_/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2));}1')
              
              echo "| $subject | $count |" >> table.tmp
              total=$((total + count))
            fi
          done
          
          echo "| **Total** | **$total** |" >> table.tmp
          
          cat table.tmp
          echo "TOTAL=$total" >> $GITHUB_ENV
      
      - name: Update README with table
        run: |
          if ! grep -q "<!-- QUESTIONS_TABLE_START -->" README.md; then
            sed -i '/This dataset contains \*\*Kankoor/a \\n<!-- QUESTIONS_TABLE_START -->\n<!-- QUESTIONS_TABLE_END -->' README.md
          fi
          
          sed -i '/<!-- QUESTIONS_TABLE_START -->/,/<!-- QUESTIONS_TABLE_END -->/{//!d;}' README.md
          sed -i '/<!-- QUESTIONS_TABLE_START -->/r table.tmp' README.md
          
          rm table.tmp
      
      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ”„ Auto-update: Total questions â†’ ${{ env.TOTAL }}"
          file_pattern: README.md
