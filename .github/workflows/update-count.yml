name: Update Total Questions

on:
  push:
    branches: [main, master]
    paths:
      - 'Afghanistan-kankoor-questions-dataset/dataset/data/**/*.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-count:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Count questions and create table
        run: |
          echo "| Subject | Questions |" > table.txt
          echo "|---------|----------|" >> table.txt
          
          total=0
          
          cd Afghanistan-kankoor-questions-dataset/dataset/data
          
          for dir in */; do
            if [ -d "$dir" ]; then
              folder=${dir%/}
              for jsonfile in "$folder"/*.json; do
                if [ -f "$jsonfile" ]; then
                  count=$(jq 'length' "$jsonfile")
                  subject=$(echo "$folder" | sed 's/_/ /g' | awk '{for(i=1;i<=NF;i++)sub(/./,toupper(substr($i,1,1)),$i)}1')
                  echo "| $subject | $count |" >> ../../../table.txt
                  total=$((total + count))
                  echo "Found $count questions in $subject"
                fi
              done
            fi
          done
          
          cd ../../..
          
          echo "| **Total** | **$total** |" >> table.txt
          
          cat table.txt
          echo "TOTAL=$total" >> $GITHUB_ENV
      
      - name: Update README
        run: |
          if grep -q "<!-- STATS -->" README.md; then
            sed -i '/<!-- STATS -->/r table.txt' README.md
            sed -i '/<!-- STATS -->/d' README.md
          else
            sed -i '1a\\n<!-- STATS -->' README.md
            sed -i '/<!-- STATS -->/r table.txt' README.md
            sed -i '/<!-- STATS -->/d' README.md
          fi
          
          rm table.txt
      
      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ“Š Update: ${{ env.TOTAL }} total questions"
          file_pattern: README.md
